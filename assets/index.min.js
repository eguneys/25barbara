class t{constructor(t){this.t=t}static i=(s,i,r,h,n)=>new t([e.i(s-h/2,i-n/2,r),e.i(s+h/2,i-n/2,r),e.i(s+h/2,i+n/2,r),e.i(s-h/2,i+n/2,r)]);static get unit(){return t.i(0,0,0,1,1)}get h(){return new Float32Array(this.t.flatMap((t=>t.u)))}get indices(){return new Uint16Array([1,0,3,1,3,2])}transform(e){return new t(this.t.map((t=>e.o(t))))}}class e{constructor(t,e,s){this.x=t,this.y=e,this.z=s}static i=(t,s,i)=>new e(t,s,i);static get unit(){return new e(1,1,1)}static get l(){return new e(0,0,0)}static get _(){return new e(0,-1,0)}static get m(){return new e(0,1,0)}static get left(){return new e(-1,0,0)}static get right(){return new e(1,0,0)}get u(){return[this.x,this.y,this.z]}get p(){return new e(1/this.x,1/this.y,1/this.z)}get inverse(){return new e(-this.x,-this.y,-this.z)}get v(){return new e(this.x/2,this.y/2,this.z/2)}get M(){return this.x*this.x+this.y*this.y+this.z*this.z}get length(){return Math.sqrt(this.M)}get normalize(){return 0===this.length?e.l:new e(this.x,this.y,this.z).scale(1/this.length)}get clone(){return e.i(this.x,this.y,this.z)}A(t){return this.x*t.x+this.y*t.y+this.z*t.z}k(t){return e.i(this.y*t.z-this.z*t.y,this.z*t.x-this.x*t.z,this.x*t.y-this.y*t.x)}q(t){return this.sub(t).length}scale(t){return e.i(this.x*t,this.y*t,this.z*t)}add(t){return e.i(this.x+t.x,this.y+t.y,this.z+t.z)}sub(t){return e.i(this.x-t.x,this.y-t.y,this.z-t.z)}mul(t){return e.i(this.x*t.x,this.y*t.y,this.z*t.z)}}class s{constructor(t){this.D=t}static i=t=>new s(t);static get identity(){return new s([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}get clone(){return new s(this.D.slice(0))}static perspective=(t,e,i,r)=>{const h=Math.tan(.5*Math.PI-.5*t);let n=1/(i-r);return new s([h/e,0,0,0,0,h,0,0,0,0,(i+r)*n,-1,0,0,i*r*n*2,0])};static F=(t,e,i,r,h,n)=>new s([2*h/(r-i),0,0,0,0,2*h/(t-e),0,0,(r+i)/(r-i),(t+e)/(t-e),-(n+h)/(n-h),-1,0,0,-2*n*h/(n-h),0]);static U=(t,e,s,i)=>{let r=s*Math.tan(.5*t),h=2*r,n=e*h,a=-.5*n,u=a+n,o=r-h;return this.F(r,o,a,u,s,i)};static L=(t,e,i)=>{let r=t.sub(e).normalize,h=i.k(r).normalize,n=r.k(h).normalize;return s.i([...h.u,0,...n.u,0,...r.u,0,...t.u,1])};static P=t=>{let[e,i,r,h]=t.D,n=e+e,a=i+i,u=r+r,o=e*n,l=i*n,c=i*a,_=r*n,w=r*a,d=r*u,g=h*n,m=h*a,p=h*u;return s.i([1-c-d,l+p,_-m,0,l-p,1-o-d,w+g,0,_+m,w-g,1-o-c,0,0,0,0,1])};get inverse(){let[t,e,i,r,h,n,a,u,o,l,c,_,w,d,g,m]=this.D,[p,v,x,f,M,A,y,b,k,z,q,D]=[t*n-e*h,t*a-i*h,t*u-r*h,e*a-i*n,e*u-r*n,i*u-r*a,o*d-l*w,o*g-c*w,o*m-_*w,l*g-c*d,l*m-_*d,c*m-_*g],F=p*D-v*q+x*z+f*k-M*b+A*y;return F?(F=1/F,new s([(n*D-a*q+u*z)*F,(i*q-e*D-r*z)*F,(d*A-g*M+m*f)*F,(c*M-l*A-_*f)*F,(a*k-h*D-u*b)*F,(t*D-i*k+r*b)*F,(g*x-w*A-m*v)*F,(o*A-c*x+_*v)*F,(h*q-n*k+u*y)*F,(e*k-t*q-r*y)*F,(w*M-d*x+m*p)*F,(l*x-o*M-_*p)*F,(n*b-h*z-a*y)*F,(t*z-e*b+i*y)*F,(d*v-w*f-g*p)*F,(o*f-l*v+c*p)*F])):null}rotate(t){return this.mul(s.P(t))}scale(t){let e=this.D;return s.i([e[0]*t.x,e[1]*t.x,e[2]*t.x,e[3]*t.x,e[4]*t.y,e[5]*t.y,e[6]*t.y,e[7]*t.y,e[8]*t.z,e[9]*t.z,e[10]*t.z,e[11]*t.z,e[12],e[13],e[14],e[15]])}translate(t){let e=this.D.slice(0);return e[12]=e[0]*t.x+e[4]*t.y+e[8]*t.z+e[12],e[13]=e[1]*t.x+e[5]*t.y+e[9]*t.z+e[13],e[14]=e[2]*t.x+e[6]*t.y+e[10]*t.z+e[14],e[15]=e[3]*t.x+e[7]*t.y+e[11]*t.z+e[15],new s(e)}mul(t){let e=this.D.slice(0),[i,r,h,n,a,u,o,l,c,_,w,d,g,m,p,v]=e,[x,f,M,A,y,b,k,z,q,D,F,U,L,P,R,S]=t.D;return e[0]=x*i+f*a+M*c+A*g,e[1]=x*r+f*u+M*_+A*m,e[2]=x*h+f*o+M*w+A*p,e[3]=x*n+f*l+M*d+A*v,e[4]=y*i+b*a+k*c+z*g,e[5]=y*r+b*u+k*_+z*m,e[6]=y*h+b*o+k*w+z*p,e[7]=y*n+b*l+k*d+z*v,e[8]=q*i+D*a+F*c+U*g,e[9]=q*r+D*u+F*_+U*m,e[10]=q*h+D*o+F*w+U*p,e[11]=q*n+D*l+F*d+U*v,e[12]=L*i+P*a+R*c+S*g,e[13]=L*r+P*u+R*_+S*m,e[14]=L*h+P*o+R*w+S*p,e[15]=L*n+P*l+R*d+S*v,new s(e)}o(t){let s=this.D,[i,r,h]=t.u,n=s[3]*i+s[7]*r+s[11]*h+s[15];return n=n||1,e.i((s[0]*i+s[4]*r+s[8]*h+s[12])/n,(s[1]*i+s[5]*r+s[9]*h+s[13])/n,(s[2]*i+s[6]*r+s[10]*h+s[14])/n)}}class i{constructor(t){this.D=t}static i=t=>new i(t);static get identity(){return i.i([0,0,0,1])}R(t){t*=.5;let e=this.D.slice(0),s=Math.sin(t),r=Math.cos(t),[h,n,a,u]=e;return e[0]=h*r+u*s,e[1]=n*r+a*s,e[2]=a*r-n*s,e[3]=u*r-h*s,new i(e)}S(t){t*=.5;let e=this.D.slice(0),s=Math.sin(t),r=Math.cos(t),[h,n,a,u]=e;return e[0]=h*r-a*s,e[1]=n*r+u*s,e[2]=a*r+h*s,e[3]=u*r-n*s,new i(e)}V(t){t*=.5;let e=this.D.slice(0),s=Math.sin(t),r=Math.cos(t),[h,n,a,u]=e;return e[0]=h*r+n*s,e[1]=n*r-h*s,e[2]=a*r+u*s,e[3]=u*r-a*s,new i(e)}}function r(t,e,s){let i=t.createShader(e);return t.shaderSource(i,s),t.compileShader(i),i}class h{constructor(t,e,s,i){this.canvas=t,this.X=e,this.Y=s,this.camera=i;let h=r(e,e.VERTEX_SHADER,"#version 300 es\nin vec4 a_pos;in vec2 a_tex;out vec2 v_tex;uniform mat4 u_matrix;void main(){gl_Position=u_matrix*a_pos;v_tex=a_tex;}"),n=r(e,e.FRAGMENT_SHADER,"#version 300 es\nprecision highp float;in vec2 v_tex;uniform sampler2D u_texture;out vec4 out_color;void main(){vec4 t_color=texture(u_texture,v_tex);out_color=t_color;}"),a=e.createProgram();e.attachShader(a,h),e.attachShader(a,n),e.linkProgram(a),e.useProgram(a),this.Z=e.createVertexArray(),e.bindVertexArray(this.Z),this.$=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.$),e.bufferData(e.ARRAY_BUFFER,8e3,e.DYNAMIC_DRAW),this.j=e.createBuffer(),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.j),e.bufferData(e.ELEMENT_ARRAY_BUFFER,2400,e.DYNAMIC_DRAW);let u=e.getAttribLocation(a,"a_pos");e.enableVertexAttribArray(u),e.vertexAttribPointer(u,3,e.FLOAT,!1,20,0);let o=e.getAttribLocation(a,"a_tex");e.enableVertexAttribArray(o),e.vertexAttribPointer(o,2,e.FLOAT,!1,20,12),e.bindVertexArray(null),this.B=e.getUniformLocation(a,"u_matrix"),this.C=e.createTexture(),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.C),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,s.canvas),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),this.G=[];for(let r=0;r<2048;r+=256)for(let t=0;t<2048;t+=256)this.G.push([r,t])}get width(){return this.canvas.width}get height(){return this.canvas.height}H=[];Z;j;$;C;B;get I(){return this.camera.J}G;K(){return this.G.shift()}N(t,e){this.G.push([t,e])}O(t,e){this.Y.save(),this.Y.translate(t,e),this.Y.fillStyle="rgba(0, 0, 0, 0)",this.Y.clearRect(0,0,256,256)}T(){this.Y.restore()}W(t,e,s,i,r){i&&(this.Y.fillStyle=i),r&&(this.Y.strokeStyle=r),this.Y.beginPath(),this.Y.arc(t,e,s,0,2*Math.PI),this.Y.closePath(),i&&this.Y.fill(),r&&this.Y.stroke()}path(t,e,s=1){let i=new Path2D(t);this.Y.strokeStyle=e,this.Y.lineWidth=s,this.Y.stroke(i)}tt(t,r,h,n,a,u,o,l,c=1,_=c,w=c){let d=i.identity.R(t).S(r).V(h),g=s.identity.translate(e.i(n,a,u)).rotate(d).scale(e.i(256,256,128)).scale(e.i(c,_,w));this.H.push([g,o,l])}et(){this.X.uniformMatrix4fv(this.B,!1,this.I.D)}once(){this.X.viewport(0,0,1920,1080),this.X.clearColor(0,0,0,1),this.X.enable(this.X.DEPTH_TEST),this.X.enable(this.X.BLEND),this.X.blendFunc(this.X.ONE,this.X.ONE_MINUS_SRC_ALPHA),this.X.depthFunc(this.X.LEQUAL)}clear(){this.X.clear(this.X.COLOR_BUFFER_BIT|this.X.DEPTH_BUFFER_BIT)}draw(){let{X:s}=this;s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,this.C),s.texImage2D(s.TEXTURE_2D,0,s.RGBA,s.RGBA,s.UNSIGNED_BYTE,this.Y.canvas);let i=this.H.length,r=new Uint16Array(6*i),h=new Float32Array(5*i*4),n=0,a=0;this.H.sort(((t,s)=>{let i=s[0].o(e.l),r=t[0].o(e.l);return i.z===r.z?r.y-i.y:i.z-r.z})).forEach(((e,s)=>{let[i,u,o]=e,l=[u,o,u+256,o,u+256,o+256,u,o+256].map((t=>t/2048)),{h:c,indices:_}=t.unit.transform(i);for(let t=0;t<c.length;t+=3)h[n++]=c[t],h[n++]=c[t+1],h[n++]=c[t+2],h[n++]=l[t/3*2],h[n++]=l[t/3*2+1];for(let t=0;t<_.length;t++)r[a++]=4*s+_[t]})),this.et(),this.H=[],s.bindBuffer(s.ARRAY_BUFFER,this.$),s.bufferSubData(s.ARRAY_BUFFER,0,h,0),s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,this.j),s.bufferSubData(s.ELEMENT_ARRAY_BUFFER,0,r,0),s.bindVertexArray(this.Z),s.drawElements(s.TRIANGLES,6*i,s.UNSIGNED_SHORT,0)}}class n{constructor(t,e){this.st=t,this.it=e}get rt(){return this.ht.inverse??s.identity}get J(){return this.nt.clone.mul(this.rt)}nt=s.U(.4*Math.PI,16/9,10,1e3);get ht(){return s.L(this.st,this.it,e._)}}const a=function(){let t=new Set;return document.addEventListener("keydown",(e=>(e=>{"ArrowUp"!==e.key&&"ArrowDown"!==e.key||e.preventDefault(),t.add(e.key)})(e))),document.addEventListener("keyup",(e=>{return s=e.key,void t.delete(s);var s})),e=>[...t].includes(e)}(),u={ut:0,ot:.016,time:0,lt:0,ct(t,e=0){let{ot:s,time:i}=this;return Math.floor((i-e-s)/t)<Math.floor((i-e)/t)}};function o(t,s,i){return new e(s.x*i+t.x*(1-i),s.y*i+t.y*(1-i),s.z*i+t.z*(1-i))}class l{constructor(t=e.l){this._t=t}get value(){return this._t}get x(){return this._t.x}wt(){return new l(e.i(this._t.x+u.ot,this._t.y+u.ot,this._t.z+u.ot))}dt(t,e){return new l(o(this._t,t._t,e))}}class c{constructor(t=e.l,s=e.l){this.position=t,this.gt=s}get value(){return this.position}wt(){let t=this.gt.clone,s=this.position.clone;return s=e.i(s.x+t.x*u.ot,s.y+t.y*u.ot,s.z+t.z*u.ot),t=e.i(.8*t.x,.8*t.y,.8*t.z),new c(s,t)}dt(t,e){return new c(o(this.position,t.position,e),o(this.gt,t.gt,e))}}class _{constructor(t,s,i=e.l,r=e.l,h=e.unit){this.g=t,this.vt=s,this.xt=this.vt.ft(new l),this.Mt=this.vt.ft(new c(i)),this.At=this.vt.ft(new c(r)),this.yt=this.vt.ft(new c(h))}xt;get _t(){return this.vt.bt(this.xt)}Mt;get transform(){return this.vt.bt(this.Mt)}set transform(t){this.vt.kt(this.Mt),this.Mt=this.vt.ft(t)}At;get rotation(){return this.vt.bt(this.At)}set rotation(t){this.vt.kt(this.At),this.At=this.vt.ft(t)}yt;get scale(){return this.vt.bt(this.yt)}set scale(t){this.vt.kt(this.yt),this.yt=this.vt.ft(t)}get zt(){let{x:t,y:e,z:s}=this.qt;return i.identity.R(t).S(e).V(s)}get Dt(){return this.transform.value}get Ft(){return this.parent===this?this.Dt:this.Dt.clone.add(this.parent.Ft)}get Ut(){return this.rotation.value}get qt(){return this.parent===this?this.Ut:this.Ut.clone.add(this.parent.qt)}Lt;Pt(t){return this.Lt=t,this}Rt(t){return this.children.filter((e=>e instanceof t))}St(t){return this.children.find((e=>e instanceof t))}Vt(t,s,i=e.l,r=e.l,h=e.unit){let n=new t(this.g,this.vt,i,r,h);return n.parent=this,n.Pt(s).init(),n}i(t,e={},s,i,r){let h=this.Vt(t,e,s,i,r);return this.children.push(h),h}parent=this;children=[];Xt;Yt;init(){return[this.Xt,this.Yt]=this.g.K(),this.Zt(),this}wt(){this.children.forEach((t=>t.wt())),this.$t()}jt(){this.Bt(),this.children.forEach((t=>t.jt()));let{Xt:t,Yt:e}=this;this.g.O(t,e),this.Lt.debug?this.Ct():this.Et(),this.g.T();let{x:s,y:i,z:r}=this.Ft,{x:h,y:n,z:a}=this.qt,{x:u,y:o,z:l}=this.scale.value;this.g.tt(h,n,a,s,i,r,t,e,u,o,l),this.Gt()}remove(){this.vt.kt(this.Mt),this.vt.kt(this.xt),this.children.forEach((t=>t.remove())),this.parent.children.splice(this.parent.children.indexOf(this),1),this.Ht()}Ct(){this.g.Y.fillStyle="white",this.g.Y.fillRect(0,0,256,256),this.g.path("M 0 0 L 0 100","red",10),this.g.path("M 128 128 L 100 100","green",10)}Zt(){}$t(){}Et(){}Bt(){}Gt(){}Ht(){}}class w extends _{jt(){this.Bt(),this.children.forEach((t=>t.jt())),this.Gt()}}class d extends _{$t(){let t=a("ArrowUp")||a("w"),i=a("ArrowDown")||a("s"),r=a("ArrowLeft")||a("d"),h=a("ArrowRight")||a("a"),n=s.P(this.parent.zt).o(e.left).scale(15),u=s.P(this.parent.zt).o(e.right).scale(15),o=s.P(this.parent.zt).o(e._).scale(15),l=s.P(this.parent.zt).o(e.m).scale(15);r?this.transform.gt=this.transform.gt.add(n):h&&(this.transform.gt=this.transform.gt.add(u)),t?this.transform.gt=this.transform.gt.add(o):i&&(this.transform.gt=this.transform.gt.add(l))}Et(){let{g:t}=this,e=2*Math.sin(4*this._t.x);t.Y.lineWidth=1;let s=128,i=108;t.path("M 138 108 A 1 1 0 0 0 138 98","red"),t.path("M 118 98 A 1 1 0 0 0 118 108","darkred"),t.path("M 138 98 A 1 1 0 0 0 118 98","red"),t.W(s,i+e,10,"red","white"),t.W(s,128,12,"red","white")}}class g extends _{Zt(){this.i(d,{},e.i(0,0,-1),e.i(.25*Math.PI,0,0*Math.PI))}Et(){let{g:t}=this;t.Y.fillStyle=`hsl(${1/13*255} 75% 50%)`,t.Y.fillRect(0,0,256,256),t.Y.fillStyle="red",t.Y.fillRect(0,0,10,10),t.Y.fillRect(236,236,20,20)}}class m extends w{Zt(){this.i(g,{},e.i(0,10,0),e.i(0,0,0),e.i(2,1,1))}$t(){}Bt(){this.g.clear()}Gt(){this.g.draw()}}class p{It;constructor(t){this.It=new m(t,this).Pt({}).init()}wt(){this.It.wt()}jt(){this.It.jt()}ft(t){return this.Jt.push(t)-1}kt(t){this.Jt.splice(t,1)}bt(t){return this.Jt[t]}Jt=[]}function v(t){t.once(),function(t){let e;const s=i=>{let r=i-(e??i);for(r>25&&(r=25),e=i,u.ut+=r/1e3,t.wt();u.ut>=u.ot;)t.Jt=t.Jt.map((t=>t.wt())),u.time+=u.ot,u.ut-=u.ot;let h=t.Jt.map((t=>t.wt())),n=u.ut/u.ot,a=t.Jt.map(((t,e)=>t.dt(h[e],n))),o=t.Jt;t.Jt=a,t.jt(),t.Jt=o,requestAnimationFrame(s)};requestAnimationFrame(s)}(new p(t))}!function(t){let s=function(t,s){let i=document.createElement("canvas"),r=i.getContext("webgl2",{antialias:!1,premultipliedAlpha:!1});const a=()=>{i.width=t,i.height=s};document.addEventListener("scroll",a,{capture:!0,passive:!0}),window.addEventListener("resize",a,{passive:!0}),a();let u=document.createElement("canvas"),o=u.getContext("2d");return u.width=2048,u.height=2048,o.imageSmoothingEnabled=!1,new h(i,r,o,new n(e.i(0,70,-160),e.i(0,0,0)))}(1920,1080);t.appendChild(s.canvas),v(s)}(document.getElementById("app"));
