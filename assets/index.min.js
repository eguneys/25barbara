class t{constructor(t){this.t=t}static i=(s,i,r,h,n)=>new t([e.i(s,i-n,r),e.i(s+h,i-n,r),e.i(s+h,i,r),e.i(s,i,r)]);static get unit(){return t.i(0,0,0,1,1)}get h(){return new Float32Array(this.t.flatMap((t=>t.u)))}get indices(){return new Uint16Array([1,0,3,1,3,2])}transform(e){return new t(this.t.map((t=>e.o(t))))}}class e{constructor(t,e,s){this.x=t,this.y=e,this.z=s}static i=(t,s,i)=>new e(t,s,i);static get unit(){return new e(1,1,1)}static get l(){return new e(0,0,0)}static get _(){return new e(0,-1,0)}get u(){return[this.x,this.y,this.z]}get m(){return new e(1/this.x,1/this.y,1/this.z)}get inverse(){return new e(-this.x,-this.y,-this.z)}get p(){return new e(this.x/2,this.y/2,this.z/2)}get v(){return this.x*this.x+this.y*this.y+this.z*this.z}get length(){return Math.sqrt(this.v)}get normalize(){return 0===this.length?e.l:new e(this.x,this.y,this.z).scale(1/this.length)}get clone(){return e.i(this.x,this.y,this.z)}M(t){return this.x*t.x+this.y*t.y+this.z*t.z}k(t){return e.i(this.y*t.z-this.z*t.y,this.z*t.x-this.x*t.z,this.x*t.y-this.y*t.x)}A(t){return this.sub(t).length}scale(t){return this.x*=t,this.y*=t,this.z*=t,this}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}sub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}mul(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this}}class s{constructor(t){this.q=t}static i=t=>new s(t);static get identity(){return new s([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}get clone(){return new s(this.q.slice(0))}static perspective=(t,e,i,r)=>{const h=Math.tan(.5*Math.PI-.5*t);let n=1/(i-r);return new s([h/e,0,0,0,0,h,0,0,0,0,(i+r)*n,-1,0,0,i*r*n*2,0])};static F=(t,e,i,r,h,n)=>new s([2*h/(r-i),0,0,0,0,2*h/(t-e),0,0,(r+i)/(r-i),(t+e)/(t-e),-(n+h)/(n-h),-1,0,0,-2*n*h/(n-h),0]);static U=(t,e,s,i)=>{let r=s*Math.tan(.5*t),h=2*r,n=e*h,a=-.5*n,u=a+n,c=r-h;return this.F(r,c,a,u,s,i)};static D=(t,e,i)=>{let r=t.sub(e).normalize,h=i.k(r).normalize,n=r.k(h).normalize;return s.i([...h.u,0,...n.u,0,...r.u,0,...t.u,1])};static P=t=>{let[e,i,r,h]=t.q,n=e+e,a=i+i,u=r+r,c=e*n,o=i*n,l=i*a,_=r*n,g=r*a,w=r*u,m=h*n,d=h*a,p=h*u;return s.i([1-l-w,o+p,_-d,0,o-p,1-c-w,g+m,0,_+d,g-m,1-c-l,0,0,0,0,1])};get inverse(){let[t,e,i,r,h,n,a,u,c,o,l,_,g,w,m,d]=this.q,[p,v,x,f,M,b,y,k,A,z,q,F]=[t*n-e*h,t*a-i*h,t*u-r*h,e*a-i*n,e*u-r*n,i*u-r*a,c*w-o*g,c*m-l*g,c*d-_*g,o*m-l*w,o*d-_*w,l*d-_*m],U=p*F-v*q+x*z+f*A-M*k+b*y;return U?(U=1/U,new s([(n*F-a*q+u*z)*U,(i*q-e*F-r*z)*U,(w*b-m*M+d*f)*U,(l*M-o*b-_*f)*U,(a*A-h*F-u*k)*U,(t*F-i*A+r*k)*U,(m*x-g*b-d*v)*U,(c*b-l*x+_*v)*U,(h*q-n*A+u*y)*U,(e*A-t*q-r*y)*U,(g*M-w*x+d*p)*U,(o*x-c*M-_*p)*U,(n*k-h*z-a*y)*U,(t*z-e*k+i*y)*U,(w*v-g*f-m*p)*U,(c*f-o*v+l*p)*U])):null}rotate(t){return this.mul(s.P(t))}scale(t){let e=this.q;return s.i([e[0]*t.x,e[1]*t.x,e[2]*t.x,e[3]*t.x,e[4]*t.y,e[5]*t.y,e[6]*t.y,e[7]*t.y,e[8]*t.z,e[9]*t.z,e[10]*t.z,e[11]*t.z,e[12],e[13],e[14],e[15]])}translate(t){let e=this.q;return e[12]=e[0]*t.x+e[4]*t.y+e[8]*t.z+e[12],e[13]=e[1]*t.x+e[5]*t.y+e[9]*t.z+e[13],e[14]=e[2]*t.x+e[6]*t.y+e[10]*t.z+e[14],e[15]=e[3]*t.x+e[7]*t.y+e[11]*t.z+e[15],this}mul(t){let e=this.q,[s,i,r,h,n,a,u,c,o,l,_,g,w,m,d,p]=e,[v,x,f,M,b,y,k,A,z,q,F,U,D,P,V,X]=t.q;return e[0]=v*s+x*n+f*o+M*w,e[1]=v*i+x*a+f*l+M*m,e[2]=v*r+x*u+f*_+M*d,e[3]=v*h+x*c+f*g+M*p,e[4]=b*s+y*n+k*o+A*w,e[5]=b*i+y*a+k*l+A*m,e[6]=b*r+y*u+k*_+A*d,e[7]=b*h+y*c+k*g+A*p,e[8]=z*s+q*n+F*o+U*w,e[9]=z*i+q*a+F*l+U*m,e[10]=z*r+q*u+F*_+U*d,e[11]=z*h+q*c+F*g+U*p,e[12]=D*s+P*n+V*o+X*w,e[13]=D*i+P*a+V*l+X*m,e[14]=D*r+P*u+V*_+X*d,e[15]=D*h+P*c+V*g+X*p,this}o(t){let s=this.q,[i,r,h]=t.u,n=s[3]*i+s[7]*r+s[11]*h+s[15];return n=n||1,e.i((s[0]*i+s[4]*r+s[8]*h+s[12])/n,(s[1]*i+s[5]*r+s[9]*h+s[13])/n,(s[2]*i+s[6]*r+s[10]*h+s[14])/n)}}class i{constructor(t){this.q=t}static i=t=>new i(t);static get identity(){return i.i([0,0,0,1])}V(t){t*=.5;let e=this.q,s=Math.sin(t),i=Math.cos(t),[r,h,n,a]=e;return e[0]=r*i+a*s,e[1]=h*i+n*s,e[2]=n*i-h*s,e[3]=a*i-r*s,this}X(t){t*=.5;let e=this.q,s=Math.sin(t),i=Math.cos(t),[r,h,n,a]=e;return e[0]=r*i-n*s,e[1]=h*i+a*s,e[2]=n*i+r*s,e[3]=a*i-h*s,this}Y(t){t*=.5;let e=this.q,s=Math.sin(t),i=Math.cos(t),[r,h,n,a]=e;return e[0]=r*i+h*s,e[1]=h*i-r*s,e[2]=n*i+a*s,e[3]=a*i-n*s,this}}function r(t,e,s){let i=t.createShader(e);return t.shaderSource(i,s),t.compileShader(i),i}class h{constructor(t,e,s,i){this.canvas=t,this.Z=e,this.j=s,this.camera=i;let h=r(e,e.VERTEX_SHADER,"#version 300 es\nin vec4 a_pos;in vec2 a_tex;out vec2 v_tex;uniform mat4 u_matrix;void main(){gl_Position=u_matrix*a_pos;v_tex=a_tex;}"),n=r(e,e.FRAGMENT_SHADER,"#version 300 es\nprecision highp float;in vec2 v_tex;uniform sampler2D u_texture;out vec4 out_color;void main(){vec4 t_color=texture(u_texture,v_tex);out_color=vec4(t_color.rgb,1.0);}"),a=e.createProgram();e.attachShader(a,h),e.attachShader(a,n),e.linkProgram(a),e.useProgram(a),this.B=e.createVertexArray(),e.bindVertexArray(this.B),this.C=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.C),e.bufferData(e.ARRAY_BUFFER,80,e.DYNAMIC_DRAW),this.G=e.createBuffer(),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.G),e.bufferData(e.ELEMENT_ARRAY_BUFFER,24,e.DYNAMIC_DRAW);let u=e.getAttribLocation(a,"a_pos");e.enableVertexAttribArray(u),e.vertexAttribPointer(u,3,e.FLOAT,!1,20,0);let c=e.getAttribLocation(a,"a_tex");e.enableVertexAttribArray(c),e.vertexAttribPointer(c,2,e.FLOAT,!1,20,12),e.bindVertexArray(null),this.H=e.getUniformLocation(a,"u_matrix"),this.I=e.createTexture(),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.I),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,s.canvas),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),this.J=[];for(let r=0;r<2048;r+=128)for(let t=0;t<2048;t+=128)this.J.push([r,t])}get width(){return this.canvas.width}get height(){return this.canvas.height}K=[];B;G;C;I;H;get L(){return this.camera.N}J;O(){return this.J.shift()}R(t,e){this.J.push([t,e])}S(t,e){this.j.save(),this.j.translate(t,e),this.j.clearRect(0,0,128,128)}T(){this.j.restore()}W(t,r,h,n,a,u,c,o){let l=i.identity.V(t).X(r).Y(h),_=s.identity.translate(e.i(n,a,u)).rotate(l).scale(e.i(128,128,0)).translate(e.i(-.5,.5,0));this.K.push([_,c,o])}$(){this.Z.uniformMatrix4fv(this.H,!1,this.L.q)}once(){this.Z.viewport(0,0,1920,1080),this.Z.clearColor(0,0,0,1),this.Z.enable(this.Z.DEPTH_TEST)}clear(){this.Z.clear(this.Z.COLOR_BUFFER_BIT|this.Z.DEPTH_BUFFER_BIT)}draw(){let{Z:e}=this;e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.I),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,this.j.canvas);let s=this.K.length,i=new Uint16Array(6*s),r=new Float32Array(5*s*4),h=0,n=0;this.K.forEach(((e,s)=>{let[a,u,c]=e,o=[u+128,c,u,c,u,c+128,u+128,c+128].map((t=>t/2048)),{h:l,indices:_}=t.unit.transform(a);for(let t=0;t<l.length;t+=3)r[h++]=l[t],r[h++]=l[t+1],r[h++]=l[t+2],r[h++]=o[t/3*2],r[h++]=o[t/3*2+1];for(let t=0;t<_.length;t++)i[n++]=4*s+_[t]})),this.$(),this.K=[],e.bindBuffer(e.ARRAY_BUFFER,this.C),e.bufferSubData(e.ARRAY_BUFFER,0,r,0),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.G),e.bufferSubData(e.ELEMENT_ARRAY_BUFFER,0,i,0),e.bindVertexArray(this.B),e.drawElements(e.TRIANGLES,6*s,e.UNSIGNED_SHORT,0)}}class n{constructor(t,e){this.tt=t,this.et=e}get st(){return this.it.inverse??s.identity}get N(){return this.rt.clone.mul(this.st)}rt=s.U(.5*Math.PI,16/9,10,1e3);get it(){return s.D(this.tt,this.et,e._)}}const a={ht:0,nt:.025,time:0,ut:0,ct(t,e=0){let{nt:s,time:i}=this;return Math.floor((i-e-s)/t)<Math.floor((i-e)/t)}};function u(t,s,i){return new e(s.x*i+t.x*(1-i),s.y*i+t.y*(1-i),s.z*i+t.z*(1-i))}class c{constructor(t=e.l){this.ot=t}get x(){return this.ot.x}lt(){return new c(e.i(this.ot.x+a.nt,this.ot.y+a.nt,this.ot.z+a.nt))}_t(t,e){return new c(u(t.ot,this.ot,e))}}class o{constructor(t=e.l,s=e.l,i=e.l){this.position=t,this.gt=s,this.wt=i}get x(){return this.position.x}get y(){return this.position.y}get z(){return this.position.y}lt(){return this}_t(t,e){return new o(u(this.position,t.position,e),u(this.gt,t.gt,e),u(this.gt,t.wt,e))}}class l{constructor(t,e,s=new o){this.g=t,this.s=e,this.dt=this.s.vt(new c),this.xt=this.s.vt(s)}dt;get ot(){return this.s.ft(this.dt)}xt;get transform(){return this.s.ft(this.xt)}Mt;bt(t){return this.Mt=t,this}yt(t){return this.children.filter((e=>e instanceof t))}kt(t){return this.children.find((e=>e instanceof t))}At(t,e,s){let i=new t(this.g,this.s,s);return i.parent=this,i.bt(e).init(),i}i(t,e={},s=new o){let i=this.At(t,e,s);return this.children.push(i),i}parent=this;children=[];zt;qt;init(){return[this.zt,this.qt]=this.g.O(),this.Ft(),this}lt(){this.children.forEach((t=>t.lt())),this.Ut()}Dt(){this.Pt(),this.children.forEach((t=>t.Dt())),this.Vt(),this.Xt()}Ft(){}Ut(){}Vt(){}Pt(){}Xt(){}}class _ extends l{Vt(){let{g:t}=this,{zt:e,qt:s}=this,i=this.ot.x;t.S(e,s),t.j.fillStyle="gold",t.j.fillRect(0,0,20,20),t.j.beginPath(),t.j.arc(64,64,64*Math.abs(Math.sin(i)),0,2*Math.PI),t.j.fill(),t.T();let{x:r,y:h,z:n}=this.transform;t.W(0,0,Math.sin(i),r,h,n,e,s)}}class g extends l{Yt;Ft(){this.Yt=this.i(_)}Pt(){this.g.clear()}Xt(){this.g.draw()}}class w{Zt;constructor(t){this.Zt=new g(t,this).bt({}).init()}lt(){this.Zt.lt()}Dt(){this.Zt.Dt()}vt(t){return this.jt.push(t)-1}ft(t){return this.jt[t]}jt=[]}function m(t){t.once(),function(t){let e;const s=i=>{let r=i-(e??i);for(r>.025&&(r=.025),e=i,a.ht+=r,t.lt();a.ht>=a.nt;)t.jt=t.jt.map((t=>t.lt())),a.time+=a.nt,a.ht-=a.nt;let h=t.jt.map((t=>t.lt())),n=a.ht/a.nt,u=t.jt.map(((t,e)=>t._t(h[e],n))),c=t.jt;t.jt=u,t.Dt(),t.jt=c,requestAnimationFrame(s)};requestAnimationFrame(s)}(new w(t))}!function(t){let s=function(t,s){let i=document.createElement("canvas"),r=i.getContext("webgl2",{antialias:!1});const a=()=>{i.width=t,i.height=s};document.addEventListener("scroll",a,{capture:!0,passive:!0}),window.addEventListener("resize",a,{passive:!0}),a();let u=document.createElement("canvas"),c=u.getContext("2d");return u.width=2048,u.height=2048,c.imageSmoothingEnabled=!1,new h(i,r,c,new n(e.i(0,0,100),e.l))}(1920,1080);t.appendChild(s.canvas),m(s)}(document.getElementById("app"));
