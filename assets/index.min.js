class t{constructor(t){this.t=t}static i=(i,e,h,r,n)=>new t([s.i(i-r/2,e-n/2,h),s.i(i+r/2,e-n/2,h),s.i(i+r/2,e+n/2,h),s.i(i-r/2,e+n/2,h)]);static get unit(){return t.i(0,0,0,1,1)}get h(){return new Float32Array(this.t.flatMap((t=>t.u)))}get indices(){return new Uint16Array([1,0,3,1,3,2])}transform(s){return new t(this.t.map((t=>s.o(t))))}}class s{constructor(t,s,i){this.x=t,this.y=s,this.z=i}static i=(t,i,e)=>new s(t,i,e);static get unit(){return new s(1,1,1)}static get l(){return new s(0,0,0)}static get _(){return new s(0,-1,0)}static get m(){return new s(0,1,0)}static get left(){return new s(-1,0,0)}static get right(){return new s(1,0,0)}get u(){return[this.x,this.y,this.z]}get p(){return new s(1/this.x,1/this.y,1/this.z)}get inverse(){return new s(-this.x,-this.y,-this.z)}get M(){return new s(this.x/2,this.y/2,this.z/2)}get v(){return this.x*this.x+this.y*this.y+this.z*this.z}get length(){return Math.sqrt(this.v)}get normalize(){return 0===this.length?s.l:new s(this.x,this.y,this.z).scale(1/this.length)}get clone(){return s.i(this.x,this.y,this.z)}A(t){return this.x*t.x+this.y*t.y+this.z*t.z}F(t){return s.i(this.y*t.z-this.z*t.y,this.z*t.x-this.x*t.z,this.x*t.y-this.y*t.x)}L(t){return this.sub(t).length}scale(t){return s.i(this.x*t,this.y*t,this.z*t)}add(t){return s.i(this.x+t.x,this.y+t.y,this.z+t.z)}sub(t){return s.i(this.x-t.x,this.y-t.y,this.z-t.z)}mul(t){return s.i(this.x*t.x,this.y*t.y,this.z*t.z)}}class i{constructor(t){this.$=t}static i=t=>new i(t);static get identity(){return new i([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}get clone(){return new i(this.$.slice(0))}static perspective=(t,s,e,h)=>{const r=Math.tan(.5*Math.PI-.5*t);let n=1/(e-h);return new i([r/s,0,0,0,0,r,0,0,0,0,(e+h)*n,-1,0,0,e*h*n*2,0])};static k=(t,s,e,h,r,n)=>new i([2*r/(h-e),0,0,0,0,2*r/(t-s),0,0,(h+e)/(h-e),(t+s)/(t-s),-(n+r)/(n-r),-1,0,0,-2*n*r/(n-r),0]);static q=(t,s,i,e)=>{let h=i*Math.tan(.5*t),r=2*h,n=s*r,a=-.5*n,u=a+n,o=h-r;return this.k(h,o,a,u,i,e)};static D=(t,s,e)=>{let h=t.sub(s).normalize,r=e.F(h).normalize,n=h.F(r).normalize;return i.i([...r.u,0,...n.u,0,...h.u,0,...t.u,1])};static U=t=>{let[s,e,h,r]=t.$,n=s+s,a=e+e,u=h+h,o=s*n,l=e*n,c=e*a,_=h*n,w=h*a,d=h*u,g=r*n,m=r*a,p=r*u;return i.i([1-c-d,l+p,_-m,0,l-p,1-o-d,w+g,0,_+m,w-g,1-o-c,0,0,0,0,1])};get inverse(){let[t,s,e,h,r,n,a,u,o,l,c,_,w,d,g,m]=this.$,[p,M,x,v,f,A,y,b,F,L,$,k]=[t*n-s*r,t*a-e*r,t*u-h*r,s*a-e*n,s*u-h*n,e*u-h*a,o*d-l*w,o*g-c*w,o*m-_*w,l*g-c*d,l*m-_*d,c*m-_*g],z=p*k-M*$+x*L+v*F-f*b+A*y;return z?(z=1/z,new i([(n*k-a*$+u*L)*z,(e*$-s*k-h*L)*z,(d*A-g*f+m*v)*z,(c*f-l*A-_*v)*z,(a*F-r*k-u*b)*z,(t*k-e*F+h*b)*z,(g*x-w*A-m*M)*z,(o*A-c*x+_*M)*z,(r*$-n*F+u*y)*z,(s*F-t*$-h*y)*z,(w*f-d*x+m*p)*z,(l*x-o*f-_*p)*z,(n*b-r*L-a*y)*z,(t*L-s*b+e*y)*z,(d*M-w*v-g*p)*z,(o*v-l*M+c*p)*z])):null}rotate(t){return this.mul(i.U(t))}scale(t){let s=this.$;return i.i([s[0]*t.x,s[1]*t.x,s[2]*t.x,s[3]*t.x,s[4]*t.y,s[5]*t.y,s[6]*t.y,s[7]*t.y,s[8]*t.z,s[9]*t.z,s[10]*t.z,s[11]*t.z,s[12],s[13],s[14],s[15]])}translate(t){let s=this.$.slice(0);return s[12]=s[0]*t.x+s[4]*t.y+s[8]*t.z+s[12],s[13]=s[1]*t.x+s[5]*t.y+s[9]*t.z+s[13],s[14]=s[2]*t.x+s[6]*t.y+s[10]*t.z+s[14],s[15]=s[3]*t.x+s[7]*t.y+s[11]*t.z+s[15],new i(s)}mul(t){let s=this.$.slice(0),[e,h,r,n,a,u,o,l,c,_,w,d,g,m,p,M]=s,[x,v,f,A,y,b,F,L,$,k,z,q,D,U,C,P]=t.$;return s[0]=x*e+v*a+f*c+A*g,s[1]=x*h+v*u+f*_+A*m,s[2]=x*r+v*o+f*w+A*p,s[3]=x*n+v*l+f*d+A*M,s[4]=y*e+b*a+F*c+L*g,s[5]=y*h+b*u+F*_+L*m,s[6]=y*r+b*o+F*w+L*p,s[7]=y*n+b*l+F*d+L*M,s[8]=$*e+k*a+z*c+q*g,s[9]=$*h+k*u+z*_+q*m,s[10]=$*r+k*o+z*w+q*p,s[11]=$*n+k*l+z*d+q*M,s[12]=D*e+U*a+C*c+P*g,s[13]=D*h+U*u+C*_+P*m,s[14]=D*r+U*o+C*w+P*p,s[15]=D*n+U*l+C*d+P*M,new i(s)}o(t){let i=this.$,[e,h,r]=t.u,n=i[3]*e+i[7]*h+i[11]*r+i[15];return n=n||1,s.i((i[0]*e+i[4]*h+i[8]*r+i[12])/n,(i[1]*e+i[5]*h+i[9]*r+i[13])/n,(i[2]*e+i[6]*h+i[10]*r+i[14])/n)}}class e{constructor(t){this.$=t}static i=t=>new e(t);static get identity(){return e.i([0,0,0,1])}C(t){t*=.5;let s=this.$.slice(0),i=Math.sin(t),h=Math.cos(t),[r,n,a,u]=s;return s[0]=r*h+u*i,s[1]=n*h+a*i,s[2]=a*h-n*i,s[3]=u*h-r*i,new e(s)}P(t){t*=.5;let s=this.$.slice(0),i=Math.sin(t),h=Math.cos(t),[r,n,a,u]=s;return s[0]=r*h-a*i,s[1]=n*h+u*i,s[2]=a*h+r*i,s[3]=u*h-n*i,new e(s)}R(t){t*=.5;let s=this.$.slice(0),i=Math.sin(t),h=Math.cos(t),[r,n,a,u]=s;return s[0]=r*h+n*i,s[1]=n*h-r*i,s[2]=a*h+u*i,s[3]=u*h-a*i,new e(s)}}function h(t,s,i){let e=t.createShader(s);return t.shaderSource(e,i),t.compileShader(e),e}class r{constructor(t,s,i,e){this.canvas=t,this.S=s,this.V=i,this.camera=e;let r=h(s,s.VERTEX_SHADER,"#version 300 es\nin vec4 a_pos;in vec2 a_tex;out vec2 v_tex;uniform mat4 u_matrix;void main(){gl_Position=u_matrix*a_pos;v_tex=a_tex;}"),n=h(s,s.FRAGMENT_SHADER,"#version 300 es\nprecision highp float;in vec2 v_tex;uniform sampler2D u_texture;out vec4 out_color;void main(){vec4 t_color=texture(u_texture,v_tex);out_color=t_color;}"),a=s.createProgram();s.attachShader(a,r),s.attachShader(a,n),s.linkProgram(a),s.useProgram(a),this.X=s.createVertexArray(),s.bindVertexArray(this.X),this.Y=s.createBuffer(),s.bindBuffer(s.ARRAY_BUFFER,this.Y),s.bufferData(s.ARRAY_BUFFER,8e3,s.DYNAMIC_DRAW),this.Z=s.createBuffer(),s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,this.Z),s.bufferData(s.ELEMENT_ARRAY_BUFFER,2400,s.DYNAMIC_DRAW);let u=s.getAttribLocation(a,"a_pos");s.enableVertexAttribArray(u),s.vertexAttribPointer(u,3,s.FLOAT,!1,20,0);let o=s.getAttribLocation(a,"a_tex");s.enableVertexAttribArray(o),s.vertexAttribPointer(o,2,s.FLOAT,!1,20,12),s.bindVertexArray(null),this.j=s.getUniformLocation(a,"u_matrix"),this.B=s.createTexture(),s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,this.B),s.texImage2D(s.TEXTURE_2D,0,s.RGBA,s.RGBA,s.UNSIGNED_BYTE,i.canvas),s.generateMipmap(s.TEXTURE_2D),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.LINEAR),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.LINEAR),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),this.G=[];for(let h=0;h<2048;h+=256)for(let t=0;t<2048;t+=256)this.G.push([h,t])}get width(){return this.canvas.width}get height(){return this.canvas.height}H=[];X;Z;Y;B;j;get I(){return this.camera.J}G;K(){return this.G.shift()}N(t,s){this.G.push([t,s])}O(t,s,i=0,e=1,h=1){this.V.save(),this.V.translate(t,s),this.V.translate(128,128),this.V.scale(e,h),this.V.rotate(i),this.V.translate(-128,-128),this.V.fillStyle="rgba(0, 0, 0, 0)",this.V.clearRect(0,0,256,256)}T(){this.V.restore()}W(t,s,i,e,h){e&&(this.V.fillStyle=e),h&&(this.V.strokeStyle=h),this.V.lineWidth=10,this.V.beginPath(),this.V.arc(t,s,i,0,2*Math.PI),this.V.closePath(),e&&this.V.fill(),h&&this.V.stroke()}path(t,s,i,e=10){let h=new Path2D(t);s&&(this.V.strokeStyle=s),i&&(this.V.fillStyle=i),this.V.lineWidth=e,s&&this.V.stroke(h),i&&this.V.fill(h)}tt(t,h,r,n,a,u,o,l,c=1,_=c,w=c){let d=e.identity.C(t).P(h).R(r),g=i.identity.translate(s.i(n,a,u)).rotate(d).scale(s.i(64,64,64)).scale(s.i(c,_,w));this.H.push([g,o,l])}st(){this.S.uniformMatrix4fv(this.j,!1,this.I.$)}once(){this.S.viewport(0,0,1920,1080),this.S.clearColor(0,0,0,1),this.S.enable(this.S.DEPTH_TEST),this.S.enable(this.S.BLEND),this.S.blendFunc(this.S.ONE,this.S.ONE_MINUS_SRC_ALPHA),this.S.depthFunc(this.S.LEQUAL)}clear(){this.S.clear(this.S.COLOR_BUFFER_BIT|this.S.DEPTH_BUFFER_BIT)}draw(){let{S:i}=this;i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,this.B),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,this.V.canvas);let e=this.H.length,h=new Uint16Array(6*e),r=new Float32Array(5*e*4),n=0,a=0;this.H.sort(((t,i)=>{let e=i[0].o(s.l),h=t[0].o(s.l);return e.z===h.z?h.y-e.y:e.z-h.z})).forEach(((s,i)=>{let[e,u,o]=s,l=[u,o,u+256,o,u+256,o+256,u,o+256].map((t=>t/2048)),{h:c,indices:_}=t.unit.transform(e);for(let t=0;t<c.length;t+=3)r[n++]=c[t],r[n++]=c[t+1],r[n++]=c[t+2],r[n++]=l[t/3*2],r[n++]=l[t/3*2+1];for(let t=0;t<_.length;t++)h[a++]=4*i+_[t]})),this.st(),this.H=[],i.bindBuffer(i.ARRAY_BUFFER,this.Y),i.bufferSubData(i.ARRAY_BUFFER,0,r,0),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,this.Z),i.bufferSubData(i.ELEMENT_ARRAY_BUFFER,0,h,0),i.bindVertexArray(this.X),i.drawElements(i.TRIANGLES,6*e,i.UNSIGNED_SHORT,0)}}class n{constructor(t,s){this.it=t,this.et=s}get ht(){return this.rt.inverse??i.identity}get J(){return this.nt.clone.mul(this.ht)}nt=i.q(.25*Math.PI,16/9,10,1e3);get rt(){return i.D(this.it,this.et,s._)}}const a=function(){let t=new Set;return document.addEventListener("keydown",(s=>(s=>{"ArrowUp"!==s.key&&"ArrowDown"!==s.key||s.preventDefault(),t.add(s.key)})(s))),document.addEventListener("keyup",(s=>{return i=s.key,void t.delete(i);var i})),s=>[...t].includes(s)}(),u={ut:0,ot:.016,time:0,lt:0,ct(t,s=0){let{ot:i,time:e}=this;return Math.floor((e-s-i)/t)<Math.floor((e-s)/t)}};const o="#000000",l="#FFF1E8",c="#FF004D",_="#FFCCAA",w=90;function d(t,s,i=u.ot){return t<s?Math.min(t+i,s):t>s?Math.max(t-i,s):t}function g(t,i,e){return new s(i.x*e+t.x*(1-e),i.y*e+t.y*(1-e),i.z*e+t.z*(1-e))}function m(t,i,e){return new s(d(t.x,i.x,e),d(t.y,i.y,e),d(t.z,i.z,e))}class p{constructor(t=s.l){this._t=t}get value(){return this._t}get x(){return this._t.x}wt(){return new p(s.i(this._t.x+u.ot,this._t.y+u.ot,this._t.z+u.ot))}dt(t,s){return new p(g(this._t,t._t,s))}}class M{constructor(t=s.l,i=s.l){this.position=t,this.gt=i}get value(){return this.position}wt(){let t=this.gt.clone,i=this.position.clone;return i=s.i(i.x+t.x*u.ot,i.y+t.y*u.ot,i.z+t.z*u.ot),t=m(t,s.l,300*u.ot),new M(i,t)}dt(t,s){return new M(g(this.position,t.position,s),g(this.gt,t.gt,s))}}class x{constructor(t,i,e=s.l,h=s.l,r=s.unit){this.g=t,this.Mt=i,this.xt=this.Mt.vt(new p),this.ft=this.Mt.vt(new M(e)),this.At=this.Mt.vt(new M(h)),this.yt=this.Mt.vt(new M(r))}xt;get _t(){return this.Mt.bt(this.xt)}ft;get transform(){return this.Mt.bt(this.ft)}set transform(t){this.Mt.Ft(this.ft),this.ft=this.Mt.vt(t)}At;get rotation(){return this.Mt.bt(this.At)}set rotation(t){this.Mt.Ft(this.At),this.At=this.Mt.vt(t)}yt;get scale(){return this.Mt.bt(this.yt)}set scale(t){this.Mt.Ft(this.yt),this.yt=this.Mt.vt(t)}get Lt(){let{x:t,y:s,z:i}=this.$t;return e.identity.C(t).P(s).R(i)}get kt(){return this.transform.value}get zt(){return this.parent===this?this.kt:this.kt.clone.add(this.parent.zt)}get qt(){return this.rotation.value}get $t(){return this.parent===this?this.qt:this.qt.clone.add(this.parent.$t)}Dt;Ut(t){return this.Dt=t,this}Ct(t){return this.children.filter((s=>s instanceof t))}Pt(t){return this.children.find((s=>s instanceof t))}Et(t,i,e=s.l,h=s.l,r=s.unit){let n=new t(this.g,this.Mt,e,h,r);return n.parent=this,n.Ut(i).init(),n}i(t,s={},i,e,h){let r=this.Et(t,s,i,e,h);return this.children.push(r),r}parent=this;children=[];Rt;St;Vt;Xt;r;init(){return[this.Rt,this.St]=this.g.K(),this.Yt(),this}wt(){this.children.forEach((t=>t.wt())),this.update()}Zt(){this.jt(),this.children.forEach((t=>t.Zt()));let{Rt:t,St:s}=this;this.g.O(t,s,this.r,this.Vt,this.Xt),this.Dt.debug?this.Bt():this.Gt(),this.g.T();let{x:i,y:e,z:h}=this.zt,{x:r,y:n,z:a}=this.$t,{x:u,y:o,z:l}=this.scale.value;this.g.tt(r,n,a,i,e,h,t,s,u,o,l),this.Ht()}remove(){this.Mt.Ft(this.ft),this.Mt.Ft(this.xt),this.children.forEach((t=>t.remove())),this.parent.children.splice(this.parent.children.indexOf(this),1),this.It()}Bt(){this.g.V.fillStyle="white",this.g.V.fillRect(0,0,256,256),this.g.path("M 0 0 L 0 100","red","red",10),this.g.path("M 128 128 L 100 100","green","green",10)}update(){this.Jt()}Yt(){}Jt(){}Gt(){}jt(){}Ht(){}It(){}}class v extends x{Zt(){this.jt(),this.children.forEach((t=>t.Zt())),this.Ht()}}class f extends x{get Kt(){return this.parent}direction=[0,0];Nt=!1;update(){let t=this.transform.gt.normalize;0===t.x&&0===t.y||this.Nt||(this.direction=[t.x,t.y]),super.update()}}class A extends f{Yt(){}Gt(){let{g:t}=this,s=this._t.x;t.V.fillStyle="gold",t.V.fillRect(0,0,20,20),t.V.beginPath(),t.V.arc(64,64,10+54*Math.abs(Math.sin(s)),0,2*Math.PI),t.V.fill()}}class y extends f{Ot=0;Qt=[0,0];Jt(){let t=a("ArrowUp")||a("w"),e=a("ArrowDown")||a("s"),h=a("ArrowLeft")||a("a"),r=a("ArrowRight")||a("d"),n=a(" ")||a("x"),o=i.U(this.parent.Lt).o(s.left).scale(w),l=i.U(this.parent.Lt).o(s.right).scale(w),c=i.U(this.parent.Lt).o(s._).scale(w),_=i.U(this.parent.Lt).o(s.m).scale(w);h?this.transform.gt=t?c.add(o):e?_.add(o):o:r?this.transform.gt=t?c.add(l):e?_.add(l):l:t?this.transform.gt=c:e&&(this.transform.gt=_);let[g,p]=this.direction;if(this.Ot>0&&(this.Ot=d(this.Ot,0,u.ot)),this.Nt=!1,this.Ot>.6?this.transform.gt=s.i(this.Qt[0],this.Qt[1],this.transform.gt.z).scale(180):this.Ot>.5?(this.Nt=!0,this.transform.gt=s.i(this.Qt[0],this.Qt[1],this.transform.gt.z).scale(-90)):this.Ot>.3&&(this.Nt=!0,this.transform.gt=m(this.transform.gt,s.l,160*u.ot)),n&&0===this.Ot){this.Qt=this.direction,this.Ot=.8;let t=this.Kt.i(b,{},this.transform.position.add(s.i(g,p,0).scale(60)),this.rotation.position);t.Vt=0===g?1:g,t.r=0===p?0:p*Math.PI*.5}}Gt(){let{g:t}=this,s=2*Math.sin(4*this._t.x),i=128,[e,h]=this.direction,r=this._t.x%3<2.3||this._t.x%3>2.6&&this._t.x%3<2.8;0===e||h<0?(t.W(i,168,40,c,o),t.W(i,108+s,64,h<0?o:c,o),t.path("M 188 128 A 1 1 0 0 0 188 68",o,o,13),t.path("M 68 68 A 1 1 0 0 0 68 128",o,o,13),t.path("M 188 68 A 1 1 0 0 0 68 68",o,void 0,13),h<0||(r?(t.path("M 98 98 L 98 108",l,l,20),t.path("M 158 98 L 158 108",l,l,20)):(t.path("M 88 108 L 108 108",l,l,20),t.path("M 148 108 L 168 108",l,l,20)))):h>=0&&(t.W(i,168,40,c,o),t.W(i,108+s,64,c,o),t.W(i-15*e,113,30,o,o),e>0?t.path("M 113 35 A 1 5 0 0 0 103 68",o,o,20):t.path("M 153 68 A 1 5 0 0 0 143 35",o,o,20),r?t.path(`M ${i+48*e} 98 L ${i+48*e} 108`,l,l,20):t.path(`M ${i+50*e} 108 L ${i+40*e} 108`,l,l,20))}}class b extends x{lines=[];Gt(){let t=this.lines.map((t=>`L ${t[0]} ${t[1]}`)).join(" "),s=this.lines.slice(0).reverse().map((t=>`L ${t[0]+80} ${t[1]}`)).join(" ");this.g.path(`M 0 256 ${t} ${s}`,"white","white")}Jt(){let t=Math.min(Math.PI,Math.PI*(11*this._t.x));this.lines.push([120*Math.sin(t),128+120*Math.cos(t)]),this._t.x>.3&&this.remove()}}class F extends x{Yt(){this.i(y,{},s.i(-100,0,-25),s.i(.25*Math.PI,0,0*Math.PI)),this.i(A,{},s.i(0,0,-25),s.i(.25*Math.PI,0,0))}Gt(){let{g:t}=this;t.V.fillStyle=_,t.V.fillRect(0,0,256,256)}}class L extends v{Yt(){this.i(F,{},s.i(0,10,0),s.i(0,0,0),s.i(6,3,3))}Jt(){}jt(){this.g.clear()}Ht(){this.g.draw()}}class ${Tt;constructor(t){this.Tt=new L(t,this).Ut({}).init()}wt(){this.Tt.wt()}Zt(){this.Tt.Zt()}vt(t){return this.Wt.push(t)-1}Ft(t){this.Wt.splice(t,1)}bt(t){return this.Wt[t]}Wt=[]}function k(t){t.once(),function(t){let s;const i=e=>{let h=e-(s??e);for(h>25&&(h=25),s=e,u.ut+=h/1e3,t.wt();u.ut>=u.ot;)t.Wt=t.Wt.map((t=>t.wt())),u.time+=u.ot,u.ut-=u.ot;let r=t.Wt.map((t=>t.wt())),n=u.ut/u.ot,a=t.Wt.map(((t,s)=>t.dt(r[s],n))),o=t.Wt;t.Wt=a,t.Zt(),t.Wt=o,requestAnimationFrame(i)};requestAnimationFrame(i)}(new $(t))}!function(t){let i=function(t,i){let e=document.createElement("canvas"),h=e.getContext("webgl2",{antialias:!0,premultipliedAlpha:!1});const a=()=>{e.width=t,e.height=i};document.addEventListener("scroll",a,{capture:!0,passive:!0}),window.addEventListener("resize",a,{passive:!0}),a();let u=document.createElement("canvas"),o=u.getContext("2d");return u.width=2048,u.height=2048,o.imageSmoothingEnabled=!0,o.lineJoin="round",o.lineCap="round",new r(e,h,o,new n(s.i(0,70,-270),s.i(0,0,0)))}(1920,1080);t.appendChild(i.canvas),k(i)}(document.getElementById("app"));
